<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lobby Blindtest</title>
<style>
body{background:#181c2f;color:#fff;font-family:'Segoe UI',Arial,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:100vh;margin:0;padding:2rem;}
.menu-container{background:#23284a;padding:2rem 3rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.2);text-align:center;width:400px;}
.participant{background:#2d3360;border:2px solid #4f5dff;border-radius:12px;padding:1rem 1.5rem;text-align:center;margin:0.5rem 0;}
button{padding:0.8rem 1.5rem;border:none;border-radius:8px;font-size:1rem;background:#4f5dff;color:#fff;cursor:pointer;transition:background 0.2s;margin-top:0.5rem;}
button:hover{background:#3741b5;}
input[type=text]{padding:0.5rem;border-radius:8px;border:none;width:80%;margin:0.3rem 0;display:block;}
#hostControls{margin-top:2rem;}
</style>
</head>
<body>

<div class="menu-container">
  <h1>Lobby Blindtest</h1>

  <h2>Participants</h2>
  <div id="participantsContainer"></div>

  <!-- Section host pour sélectionner les chansons -->
  <div id="hostControls" style="display:none;">
        <!-- Recherche Spotify -->
    <div id="spotifySearch">
      <input type="text" id="spotifyQuery" placeholder="Rechercher une musique Spotify">
      <button id="spotifySearchBtn">Rechercher</button>
      <div id="spotifyResults"></div>
    </div>

    <!-- Sélection de playlist existante -->
    <div style="margin-top:1rem;">
      <label for="playlistSelect">Charger une playlist existante :</label>
      <select id="playlistSelect"></select>
      <button id="loadPlaylistBtn">Charger</button>
    </div>
    <button id="startGameBtn">Commencer la partie</button>
    <button id="goHostBtn">Démarrer la partie (Host)</button>
    <button id="clearLobbyBtn" style="background:#ff4f4f;">Vider le lobby</button>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey:"AIzaSyBaWatcA83qeeStPCwwq4HMOQ6UwGqBWIc", authDomain:"madmax2-20cb7.firebaseapp.com", projectId:"madmax2-20cb7" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Vérifier si l'utilisateur est host via URL
const urlParams = new URLSearchParams(window.location.search);
const isHost = true; // paramètre casse-couille : urlParams.get("host") === "true";
if(isHost){
    document.getElementById("hostControls").style.display = "block";
}

let playlist = [];

function renderPlaylist() {
  const ul = document.getElementById("playlist");
  ul.innerHTML = "";
  playlist.forEach((song, idx) => {
    const li = document.createElement("li");
    li.textContent = song;
    // Bouton supprimer
    const del = document.createElement("button");
    del.textContent = "❌";
    del.style.marginLeft = "1em";
    del.onclick = () => {
      playlist.splice(idx, 1);
      renderPlaylist();
    };
    // Bouton monter
    const up = document.createElement("button");
    up.textContent = "⬆️";
    up.onclick = () => {
      if (idx > 0) {
        [playlist[idx-1], playlist[idx]] = [playlist[idx], playlist[idx-1]];
        renderPlaylist();
      }
    };
    // Bouton descendre
    const down = document.createElement("button");
    down.textContent = "⬇️";
    down.onclick = () => {
      if (idx < playlist.length-1) {
        [playlist[idx+1], playlist[idx]] = [playlist[idx], playlist[idx+1]];
        renderPlaylist();
      }
    };
    li.appendChild(up);
    li.appendChild(down);
    li.appendChild(del);
    ul.appendChild(li);
  });
}

document.getElementById("addSongBtn").onclick = () => {
  const input = document.getElementById("newSongInput");
  if (input.value.trim()) {
    playlist.push(input.value.trim());
    input.value = "";
    renderPlaylist();
  }
};

// Lors du démarrage de la partie, stocke la playlist dans Firestore
document.getElementById("startGameBtn").onclick = async () => {
  if (playlist.length === 0) return alert("Ajoutez au moins une chanson !");
  await db.collection("round").doc("current").set({
    playlist: playlist,
    start: true,
    roundNumber: 0,
    currentMusic: playlist[0]
  });
  window.location.href = "host.html";
};

renderPlaylist();

// Liste des participants en temps réel
const participantsContainer = document.getElementById("participantsContainer");
db.collection("participants").orderBy("joinedAt").onSnapshot(snapshot => {
    participantsContainer.innerHTML = "";
    snapshot.forEach(doc => {
        const div = document.createElement("div");
        div.classList.add("participant");
        div.textContent = doc.data().name + " (" + doc.data().status + ")";
        participantsContainer.appendChild(div);
    });
});

document.getElementById("clearLobbyBtn").onclick = async () => {
  const snapshot = await db.collection("participants").get();
  const batch = db.batch();
  snapshot.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  alert("Lobby vidé !");
};

// ...dans lobby.html...
const SPOTIFY_CLIENT_ID = "TA_CLE_CLIENT";
const SPOTIFY_CLIENT_SECRET = "TON_SECRET";
let spotifyToken = null;

// Obtenir le token Spotify (client credentials flow)
async function getSpotifyToken() {
  if (spotifyToken) return spotifyToken;
  const res = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "Authorization": "Basic " + btoa(SPOTIFY_CLIENT_ID + ":" + SPOTIFY_CLIENT_SECRET)
    },
    body: "grant_type=client_credentials"
  });
  const data = await res.json();
  spotifyToken = data.access_token;
  return spotifyToken;
}

// Recherche Spotify
document.getElementById("spotifySearchBtn").onclick = async () => {
  const query = document.getElementById("spotifyQuery").value.trim();
  if (!query) return;
  const token = await getSpotifyToken();
  const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
    headers: { "Authorization": "Bearer " + token }
  });
  const data = await res.json();
  const resultsDiv = document.getElementById("spotifyResults");
  resultsDiv.innerHTML = "";
  (data.tracks.items || []).forEach(track => {
    if (!track.preview_url) return; // On veut que les musiques avec preview
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.margin = "0.5em 0";
    div.innerHTML = `
      <img src="${track.album.images[0]?.url}" style="width:48px;height:48px;border-radius:8px;margin-right:1em;">
      <div style="flex:1;">
        <strong>${track.name}</strong><br>
        <span>${track.artists.map(a=>a.name).join(", ")}</span>
      </div>
      <audio src="${track.preview_url}" controls style="height:32px;"></audio>
      <button style="margin-left:1em;">Ajouter</button>
    `;
    div.querySelector("button").onclick = () => {
      playlist.push(track.preview_url);
      renderPlaylist();
    };
    resultsDiv.appendChild(div);
  });
};

// Charger les playlists existantes
async function loadPlaylistsList() {
  const select = document.getElementById("playlistSelect");
  select.innerHTML = "";
  const snap = await db.collection("playlists").get();
  snap.forEach(doc => {
    const opt = document.createElement("option");
    opt.value = doc.id;
    opt.textContent = doc.id;
    select.appendChild(opt);
  });
}
loadPlaylistsList();

document.getElementById("loadPlaylistBtn").onclick = async () => {
  const select = document.getElementById("playlistSelect");
  if (!select.value) return;
  const doc = await db.collection("playlists").doc(select.value).get();
  if (doc.exists) {
    playlist = doc.data().tracks || [];
    renderPlaylist();
  }
};

// Sauvegarder la playlist dans Firestore (optionnel, à ajouter à ton bouton)
async function saveCurrentPlaylist(name) {
  await db.collection("playlists").doc(name).set({
    tracks: playlist
  });
}

// Bouton "Démarrer la partie (Host)"
const goHostBtn = document.getElementById("goHostBtn");
goHostBtn.addEventListener("click", async () => {
    try {
        const roundRef = db.collection("round").doc("current");
        const doc = await roundRef.get();
        if (!doc.exists) {
            alert("Veuillez créer une playlist avant de commencer la partie !");
            return;
        }
        await roundRef.update({ start: true });
        window.location.href = "host.html";
    } catch(err) {
        console.error(err);
    }
});



</script>

</body>
</html>
