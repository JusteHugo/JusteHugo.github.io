<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Participant Blindtest</title>
<style>
body{background:#181c2f;color:#fff;font-family:'Segoe UI',Arial,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:2rem;}
.menu-container{background:#23284a;padding:2rem 3rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.2);text-align:center;width:400px;}
button{padding:0.8rem 1.5rem;border:none;border-radius:8px;font-size:1rem;background:#4f5dff;color:#fff;cursor:pointer;transition:background 0.2s;margin-top:1rem;}
button:hover{background:#3741b5;}
</style>
</head>
<body>

<div class="menu-container">

  <!-- Lobby -->
  <div id="lobbyContainer">
    <h2>Lobby</h2>
    <p id="lobbyStatus">En attente que vous soyez prÃªt...</p>
    <button id="readyBtn">Je suis prÃªt</button>
  </div>

  <!-- Ã‰cran de jeu -->
  <div id="gameContainer" style="display:none;">
    <h2>Blindtest</h2>
    <button id="stopBtn">Stop</button>
    <audio id="player"></audio>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ðŸ”§ Initialisation Firebase
const firebaseConfig = { apiKey:"AIzaSyBaWatcA83qeeStPCwwq4HMOQ6UwGqBWIc", authDomain:"madmax2-20cb7.firebaseapp.com", projectId:"madmax2-20cb7" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// RÃ©cupÃ©rer le nom du joueur
const playerName = prompt("Entrez votre nom");
const playerRef = db.collection("participants").doc(playerName);

// CrÃ©ation ou mise Ã  jour du joueur avec score et statut par dÃ©faut
playerRef.set({
  name: playerName,
  joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
  status: "en_attente",
  score: 0
}, { merge: true });

const lobbyContainer = document.getElementById("lobbyContainer");
const gameContainer = document.getElementById("gameContainer");
const lobbyStatus = document.getElementById("lobbyStatus");
const readyBtn = document.getElementById("readyBtn");
const stopBtn = document.getElementById("stopBtn");
const player = document.getElementById("player");

let userReady = false;

// ðŸ”˜ Quand le participant clique sur "Je suis prÃªt"
readyBtn.addEventListener("click", async () => {
  userReady = true;

  // Mise Ã  jour du statut Firestore
  await playerRef.update({ status: "pret" });

  readyBtn.disabled = true;
  lobbyStatus.textContent = "Vous Ãªtes prÃªt ! En attente du lancement de la partie...";
});

// ðŸ”„ Ecoute en temps rÃ©el du statut du joueur (mise Ã  jour UI auto)
playerRef.onSnapshot(doc => {
  if (!doc.exists) return;
  const data = doc.data();
  if (data.status === "pret") {
    readyBtn.disabled = true;
    lobbyStatus.textContent = "Vous Ãªtes prÃªt ! En attente du lancement de la partie...";
  } else {
    readyBtn.disabled = false;
    lobbyStatus.textContent = "En attente que vous soyez prÃªt...";
  }
});

// ðŸŽ¯ Ecoute du document round/current â†’ si start=true et joueur prÃªt â†’ passer en jeu
db.collection("round").doc("current").onSnapshot(doc => {
  if (!doc.exists) return;
  const data = doc.data();

  if (data.start) {
    playerRef.get().then(snapshot => {
      const playerData = snapshot.data();
      if (playerData && playerData.status === "pret") {
        // Basculer vers Ã©cran de jeu
        lobbyContainer.style.display = "none";
        gameContainer.style.display = "block";

        if (data.currentSongUrl) {
          player.src = data.currentSongUrl;
          player.play().catch(err => console.warn("Lecture bloquÃ©e :", err));
        }
      }
    });
  } else {
    // Partie pas encore lancÃ©e â†’ rester dans le lobby
    lobbyContainer.style.display = "block";
    gameContainer.style.display = "none";
  }
});

// ðŸ›‘ Bouton Stop
stopBtn.addEventListener("click", async () => {
  await db.collection("control").doc("stop").set({
    stop: true,
    player: playerName,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
});
</script>

</body>
</html>
