<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Participant Blindtest</title>
<style>
body{background:#181c2f;color:#fff;font-family:'Segoe UI',Arial,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:2rem;}
.menu-container{background:#23284a;padding:2rem 3rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.2);text-align:center;width:400px;}
button{padding:0.8rem 1.5rem;border:none;border-radius:8px;font-size:1rem;background:#4f5dff;color:#fff;cursor:pointer;transition:background 0.2s;margin-top:1rem;}
button:hover{background:#3741b5;}
</style>
</head>
<body>

<div class="menu-container">

  <!-- Lobby -->
  <div id="lobbyContainer">
    <h2>Lobby</h2>
    <p>En attente du lancement de la partie...</p>
    <button id="readyBtn">Je suis prêt</button>
  </div>

  <!-- Écran de jeu -->
  <div id="gameContainer" style="display:none;">
    <h2>Blindtest</h2>
    <button id="stopBtn">Stop</button>
    <audio id="player"></audio>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Config Firebase
const firebaseConfig = { apiKey:"AIzaSyBaWatcA83qeeStPCwwq4HMOQ6UwGqBWIc", authDomain:"madmax2-20cb7.firebaseapp.com", projectId:"madmax2-20cb7" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const playerName = prompt("Entrez votre nom");
const playerRef = db.collection("participants").doc(playerName);

// Ajouter participant avec score = 0 si inexistant
playerRef.set({
  name: playerName,
  joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
  status: "en_attente",
  score: 0
}, { merge: true });

const lobbyContainer = document.getElementById("lobbyContainer");
const gameContainer = document.getElementById("gameContainer");
const readyBtn = document.getElementById("readyBtn");
const stopBtn = document.getElementById("stopBtn");
const player = document.getElementById("player");

let userReady = false;

// Quand le participant clique "Je suis prêt"
readyBtn.addEventListener("click", () => {
  userReady = true;
  readyBtn.disabled = true;
  readyBtn.textContent = "En attente du host...";
  // Interaction utilisateur => le navigateur autorisera l'audio ensuite
});

// Écoute Firestore pour savoir quand le jeu commence
db.collection("round").doc("current").onSnapshot(doc => {
  if (!doc.exists) return;
  const data = doc.data();

  if (data.start && userReady) {
    lobbyContainer.style.display = "none";
    gameContainer.style.display = "block";

    // Lancer la musique si une URL est définie
    if (data.currentSongUrl) {
      player.src = data.currentSongUrl;
      player.play().catch(err => console.warn("Lecture bloquée :", err));
    }
  } else {
    // Retour au lobby si partie pas commencée
    lobbyContainer.style.display = "block";
    gameContainer.style.display = "none";
  }
});

// Bouton stop
stopBtn.addEventListener("click", async () => {
  await db.collection("control").doc("stop").set({
    stop: true,
    player: playerName,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
});
</script>

</body>
</html>
