<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Blindtest Host</title>
<style>
body{background:#181c2f;color:#fff;font-family:'Segoe UI',Arial,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;}
.menu-container{background:#23284a;padding:2rem 3rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.2);text-align:center;width:400px;}
.participant{background:#2d3360;border:2px solid #4f5dff;border-radius:12px;padding:1rem 1.5rem;min-width:120px;text-align:center;margin:0.5rem 0;}
button{padding:0.8rem 1.5rem;border:none;border-radius:8px;font-size:1rem;background:#4f5dff;color:#fff;cursor:pointer;transition:background 0.2s;margin-top:1rem;}
button:hover{background:#3741b5;}
</style>
</head>
<body>
<h1>Host Blindtest</h1>
<audio id="audio" controls></audio>
<div id="messageStop"></div>
<div id="chrono">00:00</div>
<button id="resumeBtn">Reprendre la musique</button>
<button id="nextBtn">Round suivant</button>
<div id="stopPanel" style="display:none; background:#23284a; padding:1rem; border-radius:12px; margin-top:1rem;">
  <p><strong id="stopPlayerName"></strong> a appuyé sur Stop !</p>
  <p>Attribuer des points :</p>
  <button class="pointBtn" data-points="1">+1</button>
  <button class="pointBtn" data-points="2">+2</button>
  <button class="pointBtn" data-points="3">+3</button>
</div>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey:"AIzaSyBaWatcA83qeeStPCwwq4HMOQ6UwGqBWIc", authDomain:"madmax2-20cb7.firebaseapp.com", projectId:"madmax2-20cb7" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const audio = document.getElementById("audio");
const messageStop = document.getElementById("messageStop");
const chrono = document.getElementById("chrono");
const resumeBtn = document.getElementById("resumeBtn");
const nextBtn = document.getElementById("nextBtn");



let playlist = ["dont-go-wasting-your-emotion-mmv.mp3","1Na29wiC0macG2Va6DXvJ5.url"];
let currentRound = 0;
let roundStartTime = null;
let intervalTimer = null;




// Démarrer round
function startRound(musicFile) {
    audio.src = musicFile;
    audio.play();
    roundStartTime = Date.now();
    startChrono();
    messageStop.textContent = "";
}

// Chrono simple
function startChrono() {
    clearInterval(intervalTimer);
    intervalTimer = setInterval(() => {
        let sec = Math.floor((Date.now() - roundStartTime)/1000);
        let min = Math.floor(sec/60);
        sec = sec % 60;
        chrono.textContent = (min<10?"0":"")+min+":"+(sec<10?"0":"")+sec;
    },1000);
}

// Écoute Stop
const stopPanel = document.getElementById("stopPanel");
const stopPlayerName = document.getElementById("stopPlayerName");
const pointBtns = document.querySelectorAll(".pointBtn");

db.collection("control").doc("stop").onSnapshot(doc => {
    if (!doc.exists) return;
    const data = doc.data();

    if (data.stop) {
        stopPlayerName.textContent = data.player;
        stopPanel.style.display = "block";
        audio.pause(); // <-- AJOUTE CETTE LIGNE pour stopper la musique côté host
    }
});

pointBtns.forEach(btn => {
    btn.addEventListener("click", async () => {
        const points = parseInt(btn.dataset.points);
        const playerName = stopPlayerName.textContent;

        if (!playerName) return;

        const playerRef = db.collection("participants").doc(playerName);

        await db.runTransaction(async (transaction) => {
            const snapshot = await transaction.get(playerRef);
            if (!snapshot.exists) return;
            const currentScore = snapshot.data().score || 0;
            transaction.update(playerRef, {
                score: currentScore + points
            });
        });

        // Réinitialiser le panneau stop après attribution des points
        await db.collection("control").doc("stop").set({ stop: false });
        stopPanel.style.display = "none";
    });
});

resumeBtn.addEventListener("click", () => { audio.play(); });

nextBtn.addEventListener("click", () => {
    currentRound = (currentRound+1) % playlist.length;
    startRound(playlist[currentRound]);
});

// Pour tester, démarrer le premier round automatiquement
startRound(playlist[currentRound]);
</script>
</body>
</html>
